<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Profile - VidSparrow</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <style>
      .profile-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      .profile-header {
        background: linear-gradient(
          135deg,
          var(--primary-dark),
          var(--secondary-dark)
        );
        border-radius: 15px;
        padding: 30px;
        margin-bottom: 30px;
        display: flex;
        align-items: center;
        gap: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      }

      .profile-picture {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        border: 4px solid var(--primary-cyan);
        object-fit: cover;
      }

      .profile-info {
        flex: 1;
      }

      .profile-name {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 5px;
        color: white;
      }

      .profile-email {
        font-size: 1.1rem;
        color: var(--text-secondary);
        margin-bottom: 15px;
      }

      .profile-stats {
        display: flex;
        gap: 30px;
      }

      .stat-item {
        text-align: center;
      }

      .stat-number {
        font-size: 2rem;
        font-weight: 700;
        color: var(--primary-cyan);
      }

      .stat-label {
        font-size: 0.9rem;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .downloads-section {
        background: var(--secondary-dark);
        border-radius: 15px;
        padding: 30px;
        margin-bottom: 30px;
      }

      .section-header {
        display: flex;
        justify-content: between;
        align-items: center;
        margin-bottom: 25px;
      }

      .section-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: white;
      }

      .action-buttons {
        display: flex;
        gap: 15px;
      }

      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .btn-danger {
        background: linear-gradient(135deg, var(--error), #d32f2f);
        color: white;
      }

      .btn-danger:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(211, 47, 47, 0.4);
      }

      .btn-secondary {
        background: var(--primary-dark);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
      }

      .btn-secondary:hover {
        background: var(--hover-dark);
      }

      .downloads-list {
        display: grid;
        gap: 15px;
      }

      .download-item {
        background: var(--primary-dark);
        border-radius: 10px;
        padding: 20px;
        display: flex;
        align-items: center;
        gap: 15px;
        transition: all 0.3s ease;
        border: 1px solid transparent;
      }

      .download-item:hover {
        border-color: var(--primary-cyan);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      }

      .download-thumbnail {
        position: relative;
        flex-shrink: 0;
      }

      .download-thumbnail img {
        width: 120px;
        height: 80px;
        border-radius: 8px;
        object-fit: cover;
      }

      .platform-badge {
        position: absolute;
        top: -8px;
        right: -8px;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        color: white;
      }

      .platform-badge.youtube {
        background: #ff0000;
      }

      .platform-badge.instagram {
        background: linear-gradient(
          45deg,
          #f09433,
          #e6683c,
          #dc2743,
          #cc2366,
          #bc1888
        );
      }

      .download-info {
        flex: 1;
        min-width: 0;
      }

      .download-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: white;
        margin-bottom: 8px;
        line-height: 1.3;
      }

      .download-meta {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        align-items: center;
      }

      .media-type {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
      }

      .media-type.mp4 {
        background: rgba(0, 123, 255, 0.2);
        color: #007bff;
        border: 1px solid #007bff;
      }

      .media-type.mp3 {
        background: rgba(40, 167, 69, 0.2);
        color: #28a745;
        border: 1px solid #28a745;
      }

      .download-date {
        color: var(--text-secondary);
        font-size: 0.9rem;
      }

      .platform-tag {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: capitalize;
        background: rgba(108, 117, 125, 0.2);
        color: #6c757d;
        border: 1px solid #6c757d;
      }

      .download-actions {
        display: flex;
        gap: 10px;
      }

      .action-btn {
        padding: 8px 12px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 5px;
      }

      .delete-btn {
        background: var(--error);
        color: white;
      }

      .delete-btn:hover {
        background: #d32f2f;
        transform: scale(1.05);
      }

      .no-downloads {
        text-align: center;
        padding: 60px 20px;
        color: var(--text-secondary);
        font-size: 1.1rem;
      }

      .report-section {
        background: var(--secondary-dark);
        border-radius: 15px;
        padding: 30px;
        margin-bottom: 30px;
      }

      .report-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }

      .report-card {
        background: var(--primary-dark);
        border-radius: 10px;
        padding: 20px;
        text-align: center;
        border: 1px solid var(--border-color);
      }

      .report-number {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--primary-cyan);
        margin-bottom: 10px;
      }

      .report-label {
        font-size: 0.9rem;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .navigation {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
      }

      .back-btn {
        background: var(--primary-dark);
        color: var(--text-primary);
        padding: 10px 20px;
        border-radius: 8px;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s ease;
      }

      .back-btn:hover {
        background: var(--hover-dark);
        transform: translateY(-2px);
      }

      @media (max-width: 768px) {
        .profile-header {
          flex-direction: column;
          text-align: center;
        }

        .profile-stats {
          justify-content: center;
        }

        .download-item {
          flex-direction: column;
          text-align: center;
        }

        .download-meta {
          justify-content: center;
        }

        .action-buttons {
          flex-direction: column;
        }

        .report-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="navigation">
        <a href="{{ url_for('index') }}" class="back-btn">
          <i class="fas fa-arrow-left"></i>
          Back to Downloader
        </a>
        <a href="{{ url_for('logout') }}" class="btn btn-secondary">
          <i class="fas fa-sign-out-alt"></i>
          Logout
        </a>
      </div>

      <div class="profile-container">
        <!-- Profile Header -->
        <div class="profile-header">
          <img
            src="{{ user.profile_pic }}"
            alt="Profile Picture"
            class="profile-picture"
            onerror="this.src='/static/images/default-avatar.png'"
          />
          <div class="profile-info">
            <h1 class="profile-name">{{ user.name }}</h1>
            <p class="profile-email">{{ user.email }}</p>
            <div class="profile-stats">
              <div class="stat-item">
                <div class="stat-number">{{ report.total_downloads }}</div>
                <div class="stat-label">Total Downloads</div>
              </div>
              <div class="stat-item">
                <div class="stat-number">{{ report.youtube_downloads }}</div>
                <div class="stat-label">YouTube</div>
              </div>
              <div class="stat-item">
                <div class="stat-number">{{ report.instagram_downloads }}</div>
                <div class="stat-label">Instagram</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Download Statistics -->
        <div class="report-section">
          <h2 class="section-title">Download Statistics</h2>
          <div class="report-grid">
            <div class="report-card">
              <div class="report-number">{{ report.mp4_downloads }}</div>
              <div class="report-label">MP4 Videos</div>
            </div>
            <div class="report-card">
              <div class="report-number">{{ report.mp3_downloads }}</div>
              <div class="report-label">MP3 Audio</div>
            </div>
            <div class="report-card">
              <div class="report-number">{{ report.last_30_days }}</div>
              <div class="report-label">Last 30 Days</div>
            </div>
            <div class="report-card">
              <div class="report-number">{{ report.favorite_platform }}</div>
              <div class="report-label">Favorite Platform</div>
            </div>
          </div>
        </div>

        <!-- Download History -->
        <div class="downloads-section">
          <div class="section-header">
            <h2 class="section-title">Download History</h2>
            <div class="action-buttons">
              <button class="btn btn-secondary" onclick="refreshDownloads()">
                <i class="fas fa-sync-alt"></i>
                Refresh
              </button>
              <button class="btn btn-danger" onclick="clearAllHistory()">
                <i class="fas fa-trash"></i>
                Clear All History
              </button>
            </div>
          </div>

          <div class="downloads-list">
            {% if downloads %} {% for download in downloads %}
            <div class="download-item">
              <div class="download-thumbnail">
                <img
                  src="{{ download.thumbnail_url or '/static/images/default-thumbnail.jpg' }}"
                  alt="{{ download.video_title }}"
                  onerror="this.src='/static/images/default-thumbnail.jpg'"
                />
                <div class="platform-badge {{ download.platform }}">
                  <i class="fab fa-{{ download.platform }}"></i>
                </div>
              </div>
              <div class="download-info">
                <h3 class="download-title">{{ download.video_title }}</h3>
                <div class="download-meta">
                  <span class="media-type {{ download.media_type }}">
                    {{ download.media_type.upper() }}
                  </span>
                  <span class="download-date">
                    {{ download.downloaded_at.strftime('%Y-%m-%d at %H:%M') }}
                  </span>
                  <span class="platform-tag"> {{ download.platform }} </span>
                </div>
              </div>
              <div class="download-actions">
                <button
                  class="action-btn delete-btn"
                  onclick="deleteDownload('{{ download.id }}')"
                  title="Delete from history"
                >
                  <i class="fas fa-trash"></i>
                  Delete
                </button>
              </div>
            </div>
            {% endfor %} {% else %}
            <div class="no-downloads">
              <i
                class="fas fa-download"
                style="font-size: 3rem; margin-bottom: 20px; opacity: 0.5"
              ></i>
              <h3>No downloads yet</h3>
              <p>Start downloading videos and they will appear here!</p>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <script>
      // Global variable to track button states
      let activeRequests = new Set();

      function deleteDownload(downloadId) {
        if (activeRequests.has(downloadId)) return;

        // Create custom alert modal for single delete
        const modal = document.createElement("div");
        modal.className = "custom-alert-modal";
        modal.innerHTML = `
      <div class="custom-alert-overlay">
        <div class="custom-alert-content">
          <div class="custom-alert-header">
            <i class="fas fa-trash-alt" style="color: #ff9800; font-size: 2rem; margin-bottom: 15px;"></i>
            <h3>Delete Download</h3>
          </div>
          <div class="custom-alert-body">
            <p>Are you sure you want to delete this download from history?</p>
          </div>
          <div class="custom-alert-footer">
            <button class="custom-alert-btn custom-alert-cancel">Cancel</button>
            <button class="custom-alert-btn custom-alert-confirm btn-danger">Delete</button>
          </div>
        </div>
      </div>
    `;

        document.body.appendChild(modal);

        // Add event listeners for custom alert buttons
        const confirmBtn = modal.querySelector(".custom-alert-confirm");
        const cancelBtn = modal.querySelector(".custom-alert-cancel");

        return new Promise((resolve) => {
          confirmBtn.onclick = () => {
            modal.remove();
            resolve(true);
          };

          cancelBtn.onclick = () => {
            modal.remove();
            resolve(false);
          };

          // Close on overlay click
          modal.querySelector(".custom-alert-overlay").onclick = (e) => {
            if (e.target === e.currentTarget) {
              modal.remove();
              resolve(false);
            }
          };
        }).then((confirmed) => {
          if (!confirmed) return;

          const button = event.target.closest(".delete-btn") || event.target;
          const originalText = button.innerHTML;

          // Show loading state
          button.innerHTML =
            '<i class="fas fa-spinner fa-spin"></i> Deleting...';
          button.disabled = true;
          activeRequests.add(downloadId);

          fetch(`/delete-download/${downloadId}`, {
            method: "DELETE",
            headers: {
              "Content-Type": "application/json",
            },
          })
            .then((response) => {
              // Check if response is JSON
              const contentType = response.headers.get("content-type");
              if (!contentType || !contentType.includes("application/json")) {
                throw new Error("Server returned non-JSON response");
              }
              return response.json();
            })
            .then((data) => {
              if (data.success) {
                showToast("Download deleted successfully", "success");
                // Remove the item from UI
                const downloadItem = button.closest(".download-item");
                if (downloadItem) {
                  downloadItem.style.opacity = "0";
                  downloadItem.style.transform = "translateX(100px)";
                  setTimeout(() => {
                    downloadItem.remove();
                    // Check if no downloads left
                    checkEmptyState();
                  }, 300);
                }
              } else {
                showToast(data.error || "Failed to delete download", "error");
                // Restore button
                button.innerHTML = originalText;
                button.disabled = false;
              }
            })
            .catch((error) => {
              console.error("Delete error:", error);
              if (error.message.includes("non-JSON")) {
                showToast(
                  "Authentication error. Please refresh the page and login again.",
                  "error"
                );
              } else {
                showToast(
                  "Network error. Please check your connection.",
                  "error"
                );
              }
              // Restore button
              button.innerHTML = originalText;
              button.disabled = false;
            })
            .finally(() => {
              activeRequests.delete(downloadId);
            });
        });
      }

      function clearAllHistory() {
        if (activeRequests.has("clear-all")) return;

        // Create custom alert modal for clear all
        const modal = document.createElement("div");
        modal.className = "custom-alert-modal";
        modal.innerHTML = `
      <div class="custom-alert-overlay">
        <div class="custom-alert-content">
          <div class="custom-alert-header">
            <i class="fas fa-exclamation-triangle" style="color: #ff9800; font-size: 2rem; margin-bottom: 15px;"></i>
            <h3>Clear All History</h3>
          </div>
          <div class="custom-alert-body">
            <p>Are you sure you want to clear ALL download history?</p>
            <p style="color: var(--error); font-weight: 600; margin-top: 10px;">This action cannot be undone!</p>
          </div>
          <div class="custom-alert-footer">
            <button class="custom-alert-btn custom-alert-cancel">Cancel</button>
            <button class="custom-alert-btn custom-alert-confirm btn-danger">Clear All</button>
          </div>
        </div>
      </div>
    `;

        document.body.appendChild(modal);

        // Add event listeners for custom alert buttons
        const confirmBtn = modal.querySelector(".custom-alert-confirm");
        const cancelBtn = modal.querySelector(".custom-alert-cancel");

        return new Promise((resolve) => {
          confirmBtn.onclick = () => {
            modal.remove();
            resolve(true);
          };

          cancelBtn.onclick = () => {
            modal.remove();
            resolve(false);
          };

          // Close on overlay click
          modal.querySelector(".custom-alert-overlay").onclick = (e) => {
            if (e.target === e.currentTarget) {
              modal.remove();
              resolve(false);
            }
          };
        }).then((confirmed) => {
          if (!confirmed) return;

          const button = event.target.closest(".btn-danger") || event.target;
          const originalText = button.innerHTML;

          // Show loading state
          button.innerHTML =
            '<i class="fas fa-spinner fa-spin"></i> Clearing...';
          button.disabled = true;
          activeRequests.add("clear-all");

          fetch("/clear-all-downloads", {
            method: "DELETE",
            headers: {
              "Content-Type": "application/json",
            },
          })
            .then((response) => {
              const contentType = response.headers.get("content-type");
              if (!contentType || !contentType.includes("application/json")) {
                throw new Error("Server returned non-JSON response");
              }
              return response.json();
            })
            .then((data) => {
              if (data.success) {
                showToast(
                  data.message || "All downloads cleared successfully",
                  "success"
                );
                const downloadsList = document.querySelector(".downloads-list");
                if (downloadsList) {
                  downloadsList.innerHTML = `
                <div class="no-downloads">
                    <i class="fas fa-download" style="font-size: 3rem; margin-bottom: 20px; opacity: 0.5;"></i>
                    <h3>No downloads yet</h3>
                    <p>Start downloading videos and they will appear here!</p>
                </div>
            `;
                }
                setTimeout(() => {
                  location.reload();
                }, 2000);
              } else {
                showToast(data.error || "Failed to clear downloads", "error");
                button.innerHTML = originalText;
                button.disabled = false;
              }
            })
            .catch((error) => {
              console.error("Clear all error:", error);
              if (error.message.includes("non-JSON")) {
                showToast(
                  "Authentication error. Please refresh the page and login again.",
                  "error"
                );
              } else {
                showToast(
                  "Network error. Please check your connection.",
                  "error"
                );
              }
              button.innerHTML = originalText;
              button.disabled = false;
            })
            .finally(() => {
              activeRequests.delete("clear-all");
            });
        });
      }

      function refreshDownloads() {
        location.reload();
      }

      function checkEmptyState() {
        const downloadsList = document.querySelector(".downloads-list");
        const downloadItems = downloadsList.querySelectorAll(".download-item");

        if (downloadItems.length === 0) {
          downloadsList.innerHTML = `
        <div class="no-downloads">
            <i class="fas fa-download" style="font-size: 3rem; margin-bottom: 20px; opacity: 0.5;"></i>
            <h3>No downloads yet</h3>
            <p>Start downloading videos and they will appear here!</p>
        </div>
    `;
        }
      }

      // Toast notification system
      function showToast(message, type = "info") {
        // Remove existing toasts
        const existingToasts = document.querySelectorAll(".toast");
        existingToasts.forEach((toast) => toast.remove());

        // Create toast element
        const toast = document.createElement("div");
        toast.className = `toast toast-${type}`;
        toast.innerHTML = `
      <div class="toast-content">
          <i class="fas ${
            type === "error" ? "fa-exclamation-circle" : "fa-check-circle"
          }"></i>
          <span>${message}</span>
      </div>
      <button class="toast-close" onclick="this.parentElement.remove()">&times;</button>
    `;

        // Add styles
        toast.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: ${
        type === "error"
          ? "#dc3545"
          : type === "success"
          ? "#28a745"
          : "#17a2b8"
      };
      color: white;
      padding: 15px 20px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
      z-index: 10000;
      max-width: 400px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      animation: slideIn 0.3s ease;
      border: 1px solid ${
        type === "error"
          ? "#dc3545"
          : type === "success"
          ? "#28a745"
          : "#17a2b8"
      };
    `;

        document.body.appendChild(toast);

        // Auto remove after 5 seconds
        setTimeout(() => {
          if (toast.parentNode) {
            toast.remove();
          }
        }, 5000);
      }

      // Add CSS for custom modals and toast animations
      const customStyles = document.createElement("style");
      customStyles.textContent = `
    /* Custom Alert Modal Styles */
    .custom-alert-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 10000;
      font-family: inherit;
    }

    .custom-alert-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(5px);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .custom-alert-content {
      background: var(--secondary-dark);
      border-radius: 15px;
      padding: 30px;
      max-width: 400px;
      width: 100%;
      text-align: center;
      border: 2px solid var(--primary-cyan);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
      animation: modalSlideIn 0.3s ease;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: scale(0.8) translateY(-20px);
      }
      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    .custom-alert-header h3 {
      color: white;
      margin: 0;
      font-size: 1.5rem;
      font-weight: 600;
    }

    .custom-alert-body {
      margin: 20px 0;
      color: var(--text-primary);
      line-height: 1.5;
    }

    .custom-alert-footer {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 25px;
    }

    .custom-alert-btn {
      padding: 12px 25px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9rem;
      transition: all 0.3s ease;
      min-width: 100px;
    }

    .custom-alert-cancel {
      background: var(--primary-dark);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
    }

    .custom-alert-cancel:hover {
      background: var(--hover-dark);
      transform: translateY(-2px);
    }

    .custom-alert-confirm {
      background: linear-gradient(135deg, var(--error), #d32f2f);
      color: white;
    }

    .custom-alert-confirm:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(211, 47, 47, 0.4);
    }

    /* Toast Styles */
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    .toast-close {
      background: none;
      border: none;
      color: white;
      font-size: 1.2rem;
      cursor: pointer;
      padding: 0;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: opacity 0.2s ease;
    }
    
    .toast-close:hover {
      opacity: 0.7;
    }
    
    .toast-content {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .download-item {
      transition: all 0.3s ease;
    }

    /* Responsive design for modal */
    @media (max-width: 480px) {
      .custom-alert-content {
        padding: 20px;
        margin: 10px;
      }
      
      .custom-alert-footer {
        flex-direction: column;
      }
      
      .custom-alert-btn {
        width: 100%;
      }
    }
  `;
      document.head.appendChild(customStyles);

      // Add smooth animations for download items
      document.addEventListener("DOMContentLoaded", function () {
        // Animate download items on load
        const downloadItems = document.querySelectorAll(".download-item");
        downloadItems.forEach((item, index) => {
          item.style.opacity = "0";
          item.style.transform = "translateY(20px)";
          setTimeout(() => {
            item.style.transition = "all 0.5s ease";
            item.style.opacity = "1";
            item.style.transform = "translateY(0)";
          }, index * 100);
        });

        // Prevent multiple clicks on buttons
        const buttons = document.querySelectorAll(".btn, .action-btn");
        buttons.forEach((btn) => {
          btn.addEventListener("click", function (e) {
            if (this.disabled) {
              e.preventDefault();
              e.stopPropagation();
              return false;
            }
          });
        });
      });
    </script>
  </body>
</html>
